<mat-card class="explanation-container">
  <!-- Explanation Column -->
  <mat-card class="explanation-card">
    <mat-card-title>
      <mat-icon>menu_book</mat-icon>
      <span>Explanation</span>
    </mat-card-title>
    <mat-card-content class="explanation-content">
      <mat-card class="sub-card">
        <div *ngIf="loadingExplanation" class="loading-container">
          <div class="spinner"></div>
          <p>Loading explanation content...</p>
        </div>
        <div class="scrollable-content" [innerHTML]="explanationText" *ngIf="!loadingExplanation"></div>
      </mat-card>
    </mat-card-content>
  </mat-card>

  <!-- Chatbot Column -->
  <mat-card class="chatbot-card">
    <mat-card-title>
      <mat-icon>smart_toy</mat-icon>
      <span>Study Assistant</span>
      <button mat-icon-button class="clear-chat-btn" matTooltip="Clear chat history" (click)="clearChat()" *ngIf="chatHistory.length > 0">
        <mat-icon>delete_sweep</mat-icon>
      </button>
    </mat-card-title>
    <mat-card-content class="chat-container">
      <div class="messages-container" #messagesContainer>
        <!-- Welcome message only shows when chat is empty -->
        <div class="welcome-message" *ngIf="chatHistory.length === 0">
          <div class="bot-avatar">
            <mat-icon>psychology</mat-icon>
          </div>
          <div class="message-content">
            Hello! I'm your study assistant. Ask me questions about the explanation and I'll help you understand.
          </div>
        </div>

        <!-- Display chat history with user and assistant messages -->
        <ng-container *ngFor="let message of chatHistory">
          <!-- User message -->
          <div class="user-chat-bubble" *ngIf="message.role === 'user'">
            <div class="user-icon">ðŸ‘¤</div>
            <div class="user-message">{{ message.content }}</div>
          </div>

          <!-- Assistant message -->
          <div class="bot-chat-bubble" *ngIf="message.role === 'assistant'">
            <div class="bot-icon">ðŸ¤–</div>
            <div class="bot-message-container">
              <markdown [data]="message.content" class="bot-response"></markdown>
              <button
                mat-icon-button
                class="speak-button"
                [class.speaking]="isSpeaking"
                (click)="isSpeaking ? stopSpeaking() : speak(message.content)"
                matTooltip="{{isSpeaking ? 'Stop speaking' : 'Listen to response'}}">
                <mat-icon>{{isSpeaking ? 'volume_up' : 'volume_down'}}</mat-icon>
              </button>
            </div>
          </div>
        </ng-container>

        <!-- Show typing indicator when loading -->
        <div class="typing-indicator" *ngIf="isLoading">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <!-- Show error messages -->
        <div class="error-message" *ngIf="errorMessage">
          <mat-icon>error_outline</mat-icon>
          {{ errorMessage }}
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <!-- Speech Recognition Status (Shows when recording) -->
      <div class="speech-status" *ngIf="isRecording">
        <span>Listening...</span>
        <div class="wave-animation">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <div class="input-container">
        <mat-form-field appearance="outline" class="input-question">
          <mat-label>Ask a question...</mat-label>
          <input
            matInput
            [(ngModel)]="prompt"
            placeholder="Type your question here..."
            (keyup.enter)="sendQuestion()"
            [disabled]="isLoading"
          />
          <mat-icon matSuffix *ngIf="!isLoading && !prompt">help_outline</mat-icon>
          <mat-icon matSuffix *ngIf="!isLoading && prompt" class="clear-icon" (click)="prompt = ''">clear</mat-icon>
          <mat-hint *ngIf="isLoading">Please wait while I process your request...</mat-hint>
        </mat-form-field>

        <!-- Speech Recognition Button -->
        <button
          mat-fab
          color="accent"
          (click)="toggleSpeechRecognition()"
          [disabled]="isLoading || !isSpeechRecognitionSupported"
          class="input-speech-button"
          aria-label="Use voice input"
          matTooltip="Click to speak your question"
          [class.recording]="isRecording"
        >
          <mat-icon>mic</mat-icon>
        </button>

        <button
          mat-fab
          color="primary"
          (click)="sendQuestion()"
          [disabled]="!prompt || isLoading"
          class="input-send-button"
          aria-label="Send message"
          matTooltip="Send question"
        >
          <mat-icon>send</mat-icon>
        </button>
        <button
          mat-fab
          color="warn"
          (click)="stopResponse()"
          [disabled]="!isLoading"
          class="input-stop-button"
          aria-label="Stop response"
          matTooltip="Stop generating response"
        >
          <mat-icon>stop</mat-icon>
        </button>
      </div>
    </mat-card-actions>
  </mat-card>
</mat-card>
